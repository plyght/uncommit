name: AI Release Notes (Managed)

on:
  push:
    branches: [main, master]
    paths:
      - 'package.json'
      - 'Cargo.toml'
      - 'pyproject.toml'
      - 'version.txt'
      - 'VERSION'
      - 'Version.swift'
      - 'version.swift'

permissions:
  contents: write

jobs:
  check-version:
    name: Check version bump
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      prev_tag: ${{ steps.check.outputs.prev_tag }}
      pkg_type: ${{ steps.check.outputs.pkg_type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect version change
        id: check
        run: |
          get_version_from_file() {
            local file=$1
            local pkg_type=$2
            
            case "$file" in
              "package.json")
                if [ -f "$file" ]; then
                  echo "pkg_type=$pkg_type" >> $GITHUB_OUTPUT
                  jq -r '.version' "$file"
                fi
                ;;
              "Cargo.toml")
                if [ -f "$file" ]; then
                  echo "pkg_type=$pkg_type" >> $GITHUB_OUTPUT
                  grep '^version' "$file" | head -1 | sed 's/.*"\(.*\)".*/\1/'
                fi
                ;;
              "pyproject.toml")
                if [ -f "$file" ]; then
                  echo "pkg_type=$pkg_type" >> $GITHUB_OUTPUT
                  grep '^version' "$file" | head -1 | sed 's/.*"\(.*\)".*/\1/'
                fi
                ;;
              "Version.swift"|"version.swift")
                if [ -f "$file" ]; then
                  echo "pkg_type=$pkg_type" >> $GITHUB_OUTPUT
                  grep -E '(let|var|static let|public static let)\s+version\s*=\s*"' "$file" | head -1 | sed 's/.*"\(.*\)".*/\1/'
                fi
                ;;
              "version.txt")
                if [ -f "$file" ]; then
                  echo "pkg_type=$pkg_type" >> $GITHUB_OUTPUT
                  cat "$file" | tr -d '[:space:]'
                fi
                ;;
              "VERSION")
                if [ -f "$file" ]; then
                  echo "pkg_type=$pkg_type" >> $GITHUB_OUTPUT
                  cat "$file" | tr -d '[:space:]'
                fi
                ;;
            esac
          }
          
          get_version() {
            local version=""
            version=$(get_version_from_file "package.json" "node")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_version_from_file "Cargo.toml" "rust")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_version_from_file "pyproject.toml" "python")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_version_from_file "Version.swift" "swift")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_version_from_file "version.swift" "swift")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_version_from_file "version.txt" "txt")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_version_from_file "VERSION" "txt")
            [ -n "$version" ] && echo "$version" && return
            echo ""
          }
          
          CURRENT=$(get_version)
          echo "Current version: $CURRENT"
          
          if [ -z "$CURRENT" ]; then
            echo "No version file found"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git show HEAD^:package.json 2>/dev/null > /tmp/old_pkg.json || true
          git show HEAD^:Cargo.toml 2>/dev/null > /tmp/old_cargo.toml || true
          git show HEAD^:pyproject.toml 2>/dev/null > /tmp/old_pyproject.toml || true
          git show HEAD^:Version.swift 2>/dev/null > /tmp/old_Version.swift || true
          git show HEAD^:version.swift 2>/dev/null > /tmp/old_version.swift || true
          git show HEAD^:version.txt 2>/dev/null > /tmp/old_version.txt || true
          git show HEAD^:VERSION 2>/dev/null > /tmp/old_VERSION || true
          
          get_old_version_from_file() {
            local file=$1
            local old_file=$2
            
            if [ ! -f "$file" ] || [ ! -s "$old_file" ]; then
              return
            fi
            
            case "$file" in
              "package.json")
                jq -r '.version' "$old_file" 2>/dev/null
                ;;
              "Cargo.toml")
                grep '^version' "$old_file" | head -1 | sed 's/.*"\(.*\)".*/\1/'
                ;;
              "pyproject.toml")
                grep '^version' "$old_file" | head -1 | sed 's/.*"\(.*\)".*/\1/'
                ;;
              "Version.swift"|"version.swift")
                grep -E '(let|var|static let|public static let)\s+version\s*=\s*"' "$old_file" | head -1 | sed 's/.*"\(.*\)".*/\1/'
                ;;
              "version.txt")
                cat "$old_file" | tr -d '[:space:]'
                ;;
              "VERSION")
                cat "$old_file" | tr -d '[:space:]'
                ;;
            esac
          }
          
          get_old_version() {
            local version=""
            version=$(get_old_version_from_file "package.json" "/tmp/old_pkg.json")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_old_version_from_file "Cargo.toml" "/tmp/old_cargo.toml")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_old_version_from_file "pyproject.toml" "/tmp/old_pyproject.toml")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_old_version_from_file "Version.swift" "/tmp/old_Version.swift")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_old_version_from_file "version.swift" "/tmp/old_version.swift")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_old_version_from_file "version.txt" "/tmp/old_version.txt")
            [ -n "$version" ] && echo "$version" && return
            version=$(get_old_version_from_file "VERSION" "/tmp/old_VERSION")
            [ -n "$version" ] && echo "$version" && return
            echo "0.0.0"
          }
          
          PREVIOUS=$(get_old_version)
          echo "Previous version: $PREVIOUS"
          
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          
          if git ls-remote --tags origin | grep -q "refs/tags/v$CURRENT"; then
            echo "Tag v$CURRENT exists, skipping"
            echo "should_release=false" >> $GITHUB_OUTPUT
          elif [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "Version changed: $PREVIOUS -> $CURRENT"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
          else
            echo "Version unchanged"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  release:
    name: Generate notes and release
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate AI release notes via Uncommit API
        id: notes
        env:
          UNCOMMIT_WEBHOOK_SECRET: ${{ secrets.UNCOMMIT_WEBHOOK_SECRET }}
          UNCOMMIT_API_URL: ${{ secrets.UNCOMMIT_API_URL }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          PREV_TAG="${{ needs.check-version.outputs.prev_tag }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          if [ -n "$PREV_TAG" ]; then
            DIFF=$(git diff "$PREV_TAG"..HEAD -- '*.js' '*.ts' '*.jsx' '*.tsx' '*.rs' '*.py' '*.go' '*.java' '*.rb' '*.php' '*.cs' '*.swift' '*.kt' 'package.json' 'Cargo.toml' 'pyproject.toml' 'Version.swift' 'version.swift' 2>/dev/null | head -c 80000 || echo "")
          else
            FIRST=$(git rev-list --max-parents=0 HEAD)
            DIFF=$(git diff "$FIRST"..HEAD -- '*.js' '*.ts' '*.jsx' '*.tsx' '*.rs' '*.py' '*.go' '*.java' '*.rb' '*.php' '*.cs' '*.swift' '*.kt' 'package.json' 'Cargo.toml' 'pyproject.toml' 'Version.swift' 'version.swift' 2>/dev/null | head -c 80000 || echo "")
          fi
          
          if [ -z "$DIFF" ] || [ "$DIFF" = "" ]; then
            echo "notes=Maintenance release." >> $GITHUB_OUTPUT
            exit 0
          fi
          
          REQUEST=$(jq -n \
            --arg repoOwner "$REPO_OWNER" \
            --arg repoName "$REPO_NAME" \
            --arg version "$VERSION" \
            --arg diff "$DIFF" \
            --arg provider "anthropic" \
            '{
              repoOwner: $repoOwner,
              repoName: $repoName,
              version: $version,
              diff: $diff,
              provider: $provider
            }')
          
          RESPONSE=$(curl -s "${UNCOMMIT_API_URL:-https://uncommit.sh}/ai/generate-release" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $UNCOMMIT_WEBHOOK_SECRET" \
            -d "$REQUEST")
          
          NOTES=$(echo "$RESPONSE" | jq -r '.notes // empty')
          
          if [ -z "$NOTES" ]; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"')
            echo "Error from Uncommit API: $ERROR"
            NOTES="Maintenance release."
          fi
          
          echo "$NOTES" > /tmp/notes.md
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.check-version.outputs.version }}" -m "v${{ needs.check-version.outputs.version }}"
          git push origin "v${{ needs.check-version.outputs.version }}"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: v${{ needs.check-version.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
